@using CAT.AID.Models
@using CAT.AID.Models.DTO
@using CAT.AID.Web.Models.DTO

@model Assessment

@{
    var recommendations = ViewBag.Recommendations as Dictionary<string, List<string>>;
    var weakDetails = ViewBag.WeakDetails as Dictionary<string, List<string>>;
    var sections = ViewBag.Sections as List<AssessmentSection>;

    var saved = string.IsNullOrWhiteSpace(Model.AssessmentResultJson)
        ? new Dictionary<string, string>()
        : System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(Model.AssessmentResultJson);

    var score = string.IsNullOrWhiteSpace(Model.ScoreJson)
        ? new AssessmentScoreDTO()
        : System.Text.Json.JsonSerializer.Deserialize<AssessmentScoreDTO>(Model.ScoreJson);

    var candidate = Model.Candidate;
}

<style>
    .glass-card {
        background: rgba(255,255,255,0.75);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0px 10px 28px rgba(0,0,0,0.15);
    }

    .soft-card {
        background: #f7f9ff;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #dce6ff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

        .soft-card:hover {
            transform: scale(1.01);
            transition: 0.25s ease;
            box-shadow: 0 4px 14px rgba(0,0,0,0.15);
        }

    .metric-box {
        border-radius: 12px;
        padding: 12px;
        background: rgba(240,248,255,0.7);
        box-shadow: 0px 3px 10px rgba(0,0,0,0.1);
    }
</style>

<h3 class="text-primary fw-bold">Assessment Result ‚Äî @candidate.FullName</h3>

<!-- ========================= CANDIDATE INFO SECTION ========================= -->
<div class="card shadow-sm p-3 mb-4">
    <h4 class="fw-bold text-primary mb-3">üßë‚Äçüíº Candidate Information</h4>

    <div class="row g-3">
        <div class="col-md-3 text-center">
            <img src="@candidate.PhotoFilePath"
                 class="border rounded"
                 style="width:140px;height:160px;object-fit:cover;" />
        </div>
<div class="card mt-4">
    <div class="card-header fw-bold">
        üìù Overall Summary (Assessor)
    </div>

    <div class="card-body">
        <textarea class="form-control" rows="4" readonly>
@ViewBag.Summary
        </textarea>
    </div>
</div>

        <div class="col-md-9">
            <table class="table table-bordered">
                <tr><th>Name</th><td>@candidate.FullName</td></tr>
                <tr><th>Gender</th><td>@candidate.Gender</td></tr>
                <tr><th>Date of Birth</th><td>@candidate.DOB.ToString("dd-MMM-yyyy")</td></tr>
                <tr><th>Intellectual Disability</th><td>@candidate.IntellectualLevel</td></tr>
                <tr><th>Education</th><td>@candidate.Education</td></tr>
                <tr><th>Marital Status</th><td>@candidate.MaritalStatus</td></tr>
            </table>
        </div>

        <div class="col-12"><hr /></div>

        <!-- Family Section -->
        <h5 class="fw-bold text-primary">üë®‚Äçüë©‚Äçüë¶ Family Details</h5>

        <div class="col-md-6">
            <table class="table table-bordered">
                <tr><th>Father Name</th><td>@candidate.FatherName</td></tr>
                <tr><th>Father Education</th><td>@candidate.FatherEducation</td></tr>
                <tr><th>Father Occupation</th><td>@candidate.FatherOccupation</td></tr>
            </table>
        </div>

        <div class="col-md-6">
            <table class="table table-bordered">
                <tr><th>Mother Name</th><td>@candidate.MotherName</td></tr>
                <tr><th>Mother Education</th><td>@candidate.MotherEducation</td></tr>
                <tr><th>Mother Occupation</th><td>@candidate.MotherOccupation</td></tr>
            </table>
        </div>

        <div class="col-12">
            <table class="table table-bordered">
                <tr><th>Languages</th><td>@candidate.MotherTongue / @candidate.OtherLanguages</td></tr>
                <tr><th>Family Type</th><td>@candidate.FamilyType</td></tr>
                <tr><th>Residential Area</th><td>@candidate.ResidentialArea</td></tr>
                <tr><th>Contact</th><td>@candidate.ContactNumber</td></tr>
                <tr><th>Address</th><td>@candidate.CommunicationAddress</td></tr>
            </table>
        </div>

        <!-- Attachments -->
        <div class="col-12">
            <h5 class="fw-bold text-primary mt-3">üìÇ Candidate Attachments</h5>

            <div class="d-flex flex-wrap gap-3">
                @if (ViewBag.Attachments != null && ((List<CandidateAttachment>)ViewBag.Attachments).Any())
                {
                    foreach (var doc in (List<CandidateAttachment>)ViewBag.Attachments)
                    {
                        <div class="border p-2 text-center" style="width:120px;">
                            @if (doc.FileType.StartsWith("image"))
                            {
                                <img src="/uploads/candidates/@doc.FilePath" style="width:80px;height:80px;object-fit:cover;" />
                            }
                            else if (doc.FileType.Contains("pdf"))
                            {
                                <img src="/images/pdf-icon.png" style="height:50px;" />
                            }
                            else
                            {
                                <img src="/images/doc-icon.png" style="height:50px;" />
                            }
                            <div class="small mt-1">@doc.FileName</div>

                            <a href="/uploads/candidates/@doc.FilePath"
                               class="btn btn-outline-primary btn-sm mt-1"
                               target="_blank">View</a>
                        </div>
                    }
                }
                else
                {
                    <span class="text-muted">No attachments.</span>
                }
            </div>
        </div>
    </div>
</div>
<!-- ========================= END CANDIDATE INFO ========================= -->

<div class="glass-card mb-3">
    <strong>Assessor:</strong> @(Model.Assessor?.FullName ?? "N/A") <br />
    <strong>Status:</strong> <strong>@Model.Status</strong>
</div>

@{
    double iqPercent = score.MaxScore > 0 ? Math.Round(((double)score.TotalScore / score.MaxScore) * 100, 2) : 0;
    string iqLevel = iqPercent >= 80 ? "Highly Developed" :
                     iqPercent >= 60 ? "Above Average" :
                     iqPercent >= 40 ? "Average" :
                     "Below Average";
    string iqColor = iqPercent >= 80 ? "#007A33" :
                     iqPercent >= 60 ? "#003366" :
                     iqPercent >= 40 ? "#FFA500" :
                     "#50308A";
}

<div class="metric-box mb-3" style="border-left: 6px solid @iqColor;">
    <strong>IQ %:</strong> <span style="color:@iqColor;font-weight:bold">@iqPercent%</span>
    &nbsp;|&nbsp;
    <strong>IQ Level:</strong> <span style="color:@iqColor;font-weight:bold">@iqLevel</span>
</div>

<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#report">üìä Report</a></li>
    <li class="nav-item ms-auto"><span class="nav-link disabled fw-bold">IQ %: @iqPercent %</span></li>
</ul>

<div class="tab-content mt-3">

    <div id="report" class="tab-pane fade show active">

        <!-- CHARTS -->
        <div class="row text-center mb-4">
            <div class="col-md-6"><div class="soft-card"><canvas id="barChart" height="220"></canvas></div></div>
            <div class="col-md-6"><div class="soft-card"><canvas id="doughnutChart" height="220"></canvas></div></div>
        </div>

        <hr />

        <h5 class="fw-bold">Key Metrics</h5>
        <div class="soft-card">
            <ul>
                <li><strong>Total Score:</strong> @score.TotalScore / @score.MaxScore</li>
                <li><strong>Completed At:</strong> @(Model.SubmittedAt?.ToString("dd-MMM-yyyy HH:mm") ?? "N/A")</li>
            </ul>
        </div>

        <hr />

        <!-- RECOMMENDATIONS -->
        <h5 class="fw-bold text-primary">üéØ Recommendations</h5>
        @if (recommendations?.Any() == true)
        {
            foreach (var r in recommendations)
            {
                <div class="soft-card mb-2">
                    <h6 class="fw-bold text-primary">@r.Key</h6>
                    <ul>
                        @foreach (var rec in r.Value)
                        {
                            <li>@rec</li>
                        }
                    </ul>
                </div>
            }
        }
        else
        {
            <div class="alert alert-primary">No recommendations required.</div>
        }

        <hr />

        <!-- WEAK DETAILS -->
        @if (weakDetails?.Any() == true)
        {
            <h5 class="fw-bold text-primary">üß† Weak Areas</h5>
            @foreach (var wd in weakDetails)
            {
                <div class="soft-card bg-light mb-2">
                    <h6 class="fw-bold text-primary">@wd.Key</h6>
                    <ul>
                        @foreach (var d in wd.Value)
                        {
                            <li>@d</li>
                        }
                    </ul>
                </div>
            }
        }

        <hr />

        <!-- SECTION PERFORMANCE -->
        @if (score.SectionScores.Any())
        {
            var strongest = score.SectionScores.OrderByDescending(x => x.Value).First();
            var weakest = score.SectionScores.OrderBy(x => x.Value).First();
            <p class="fw-bold text-success">üü¢ Strongest: @strongest.Key (@strongest.Value)</p>
            <p class="fw-bold text-danger">üîª Weakest: @weakest.Key (@weakest.Value)</p>
        }

        <hr />

        <!-- QUESTION TABLE WITH EVIDENCE -->
        @foreach (var sec in sections)
        {
            <h5 class="fw-bold text-info mt-4">@sec.Category</h5>

            <table class="table table-bordered table-sm shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Q ID</th>
                        <th>Question</th>
                        <th>Answer</th>
                        <th>Score</th>
                        <th>Comments</th>
                        <th>Evidence</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var q in sec.Questions)
                    {
                        saved.TryGetValue($"ANS_{q.Id}", out string ans);
                        saved.TryGetValue($"SCORE_{q.Id}", out string scr);
                        saved.TryGetValue($"CMT_{q.Id}", out string cmt);

                        var files = saved
                        .Where(x => x.Key.StartsWith($"FILE_{q.Id}"))
                        .Select(x => x.Value)
                        .ToList();

                        <tr>
                            <td>@q.Id</td>
                            <td>@q.Text</td>
                            <td>@(ans ?? "-")</td>
                            <td>@(scr ?? "0")</td>
                            <td>@(cmt ?? "-")</td>
                            <td>
                                @if (files.Any())
                                {
                                    foreach (var f in files)
                                    {
                                        <div><a href="/uploads/@f" target="_blank" class="btn btn-outline-primary btn-sm">üìé View</a></div>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">‚Äî</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <div class="text-end mt-3">
            <form method="post" action="/Assessments/ExportReportPdf/@Model.Id">
                <input type="hidden" id="barChartImage" name="barChartImage" />
                <input type="hidden" id="doughnutChartImage" name="doughnutChartImage" />
                <button class="btn btn-primary">üìÑ Download PDF</button>
            </form>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const labels = @Html.Raw(Json.Serialize(score.SectionScores.Keys));
    const values = @Html.Raw(Json.Serialize(score.SectionScores.Values));

    const total = @score.TotalScore;
    const remaining = @score.MaxScore - @score.TotalScore;

    new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Section Score",
                data: values,
                backgroundColor: "#1F5CAA",
                borderColor: "#003366",
                borderWidth: 2
            }]
        }
    });

    new Chart(document.getElementById("doughnutChart"), {
        type: "doughnut",
        data: {
            labels: ["Achieved", "Remaining"],
            datasets: [{
                data: [total, remaining],
                backgroundColor: ["#003366", "#9bbde6"]
            }]
        }
    });

    setTimeout(() => {
        document.getElementById("barChartImage").value =
            document.getElementById("barChart").toDataURL().split(",")[1];

        document.getElementById("doughnutChartImage").value =
            document.getElementById("doughnutChart").toDataURL().split(",")[1];
    }, 1200);
</script>

